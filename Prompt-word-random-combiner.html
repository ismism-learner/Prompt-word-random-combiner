<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提示词随机组合器</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            padding: 20px;
            color: #333;
        }
        .main-layout {
            display: flex;
            max-width: 1300px; 
            margin: 0 auto;
            gap: 20px;
        }
        .container {
            flex: 3; 
            min-width: 600px;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .sidebar {
            flex: 1; 
            min-width: 300px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .sidebar-header h2 {
            margin: 0;
            color: #1e88e5;
        }
        /* 加号按钮样式 */
        .btn-add-combination {
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-add-combination:hover {
            background-color: #45a049;
        }
        /* 列表样式 */
        #combination-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 50vh; 
            overflow-y: auto; 
            margin-bottom: 20px;
        }
        .combination-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .combination-item:hover {
            background-color: #f5f5f5;
        }
        .item-name {
            font-weight: bold;
            color: #333;
            flex-grow: 1;
            padding-right: 10px;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; 
        }
        .item-delete {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .item-delete:hover {
            opacity: 1;
        }
        
        /* 按钮和输出样式 */
        h1 { text-align: center; color: #1e88e5; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; } 
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .input-group textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; resize: vertical; box-sizing: border-box; font-size: 14px; }
        .btn { display: block; width: 100%; padding: 12px; color: white; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; transition: background-color 0.3s; box-sizing: border-box; text-align: center; }
        .btn-generate { background-color: #4caf50; }
        .btn-generate:hover { background-color: #45a049; }
        .btn-save { background-color: #ff9800; }
        .btn-save:hover { background-color: #fb8c00; }
        .btn-load { background-color: #2196f3; }
        .btn-load:hover { background-color: #1e88e5; }
        
        #output-area { flex: 1; padding: 15px; border: 2px solid #1e88e5; border-radius: 6px; background-color: #e3f2fd; word-break: break-all; font-size: 16px; font-weight: 500; }
        .note { margin-top: 20px; text-align: center; color: #888; font-size: 12px; }
        .button-group { display: flex; gap: 10px; margin-bottom: 20px; }
        #file-input-label { flex: 1; cursor: pointer; }
        #file-input { display: none; }

        /* 批量生成区域样式 */
        .batch-area {
            border-top: 2px solid #e0e0e0;
            padding-top: 15px;
            margin-top: 15px;
        }
        .batch-area h3 {
            margin-top: 0;
            color: #00bcd4;
        }
        .batch-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .batch-input-group label {
            font-weight: bold;
            color: #555;
            white-space: nowrap;
        }
        .batch-input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            text-align: center;
            /* 核心CSS修改：隐藏 type="number" 的上下箭头 */
            -moz-appearance: textfield; /* Firefox */
        }
        /* Webkit (Chrome, Safari, Edge) */
        .batch-input-group input::-webkit-outer-spin-button,
        .batch-input-group input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .btn-batch-generate {
            background-color: #00bcd4; /* 青色 */
            font-size: 16px;
            padding: 10px;
        }
        .btn-batch-generate:hover {
            background-color: #00acc1;
        }

        /* 错误/通知窗口样式 */
        #notification-box {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            max-width: 80%;
            font-size: 14px;
            pointer-events: none; /* 允许点击穿透 */
        }
        #notification-box.show {
            opacity: 1;
            visibility: visible;
        }
        #notification-box.error {
            background-color: #f44336; /* 红色 */
        }
        #notification-box.success {
            background-color: #4CAF50; /* 绿色 */
        }
        #notification-box.info {
            background-color: #2196F3; /* 蓝色 */
        }
    </style>
</head>
<body>

<div class="main-layout">
    <div class="container">
        <h1>🎨 提示词随机组合器</h1>
        <p>将每组提示词粘贴在对应的文本框中，每行一个提示词。数据将自动保存在浏览器中。</p>
        
        <div class="grid">
            <div class="input-group"><label for="不修改的">1. 不修改的提示词 (基底)</label><textarea id="不修改的"></textarea></div>
            <div class="input-group"><label for="套装">2. 套装</label><textarea id="套装"></textarea></div>
            <div class="input-group"><label for="上装">3. 上装</label><textarea id="上装"></textarea></div>
            <div class="input-group"><label for="下装">4. 下装</label><textarea id="下装"></textarea></div>
            <div class="input-group"><label for="身体配饰">5. 身体配饰</label><textarea id="身体配饰"></textarea></div>
            
            <div class="input-group"><label for="前发">6a. 前发</label><textarea id="前发"></textarea></div>
            <div class="input-group"><label for="后发">6b. 后发</label><textarea id="后发"></textarea></div>
            <div class="input-group"><label for="完整发型">6c. 完整发型</label><textarea id="完整发型"></textarea></div>
            <div class="input-group"><label for="发色">7. 发色</label><textarea id="发色"></textarea></div>
            
            <div class="input-group"><label for="表情">8. 表情</label><textarea id="表情"></textarea></div>
            
            <div class="input-group"><label for="姿势">9. 姿势</label><textarea id="姿势"></textarea></div>
            <div class="input-group"><label for="镜头">10. 镜头</label><textarea id="镜头"></textarea></div>
        </div>

        <div class="button-group">
            <label for="file-input" id="file-input-label">
                <div class="btn btn-load">📤 加载分类提示词和收藏 (.txt)</div>
                <input type="file" id="file-input" accept=".txt" onchange="loadFromTXT(event)">
            </label>
            <button onclick="saveToTXT()" class="btn btn-save" style="flex: 1;">💾 保存分类提示词和收藏 (.txt)</button>
        </div>

        <button onclick="generatePrompt()" class="btn btn-generate">生成组合提示词并复制</button>

        <div style="margin-top: 30px; display: flex;">
            <div id="output-area" style="flex: 1;">点击“生成组合提示词并复制”按钮...</div>
        </div>

        <div class="note">
            注意：服装部分会随机选择 "套装" 或 "上装 + 下装"。<br>
            **发型部分会随机选择 "前发 + 后发" 或 "完整发型"**。<br>
            所有输入内容会自动保存在您浏览器的本地存储 (Local Storage) 中。
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>组合收藏夹</h2>
            <button onclick="promptAndSaveCombination()" class="btn-add-combination" title="手动添加新组合">+</button>
        </div>
        <p style="font-size: 12px; color: #888;">点击列表项可复制内容</p>
        <ul id="combination-list">
        </ul>
        
        <div class="batch-area">
            <h3>🚀 批量生成器</h3>
            <div class="batch-input-group">
                <label for="batch-count">生成数量:</label>
                <input type="number" id="batch-count" value="10" min="1" max="1000" oninput="validateNumberInput(this)">
            </div>
            <button onclick="batchGenerateAndSaveToTXT()" class="btn btn-batch-generate">批量生成并保存为TXT</button>
        </div>
        </div>
</div>

<div id="notification-box"></div>

<script>
    /**
     * 自定义通知函数 (取代 alert/confirm)
     */
    function notify(message, type = 'info', duration = 3000) {
        const box = document.getElementById('notification-box');
        box.innerText = message;
        box.className = `show ${type}`; 

        clearTimeout(box.timer);
        box.timer = setTimeout(() => {
            box.className = '';
        }, duration);
    }
    
    // 确保输入框只包含数字
    function validateNumberInput(input) {
        input.value = input.value.replace(/[^0-9]/g, '');
        if (input.value === '' || parseInt(input.value, 10) === 0) {
            input.value = 1;
        }
    }

    const CATEGORIES = [
        "不修改的", "套装", "上装", "下装", "身体配饰", 
        "前发", "后发", "完整发型",
        "发色", 
        "表情", 
        "姿势", "镜头"
    ];
    const COMBINATIONS_KEY = "prompt_combinations"; 

    function loadData() {
        CATEGORIES.forEach(id => {
            const data = localStorage.getItem(`prompt_${id}`);
            if (data) {
                document.getElementById(id).value = data;
            }
        });
        renderCombinations(); 
    }

    function saveData() {
        CATEGORIES.forEach(id => {
            const textarea = document.getElementById(id);
            localStorage.setItem(`prompt_${id}`, textarea.value);
        });
    }
    
    function selectRandomPrompt(id) {
        const text = document.getElementById(id).value;
        const prompts = text.split('\n')
                            .map(p => p.trim())
                            .filter(p => p.length > 0);
        
        return prompts.length > 0 ? prompts[Math.floor(Math.random() * prompts.length)] : "";
    }

    function loadCombinations() {
        const data = localStorage.getItem(COMBINATIONS_KEY);
        try {
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error("Error loading combinations from local storage:", e);
            return [];
        }
    }

    function saveCombinations(combinations) {
        localStorage.setItem(COMBINATIONS_KEY, JSON.stringify(combinations));
    }

    // 保持使用 prompt 收集输入，因为这是获取用户输入文本的最简洁方式
    function promptAndSaveCombination() {
        const defaultName = `组合 #${Date.now() % 10000}`;
        
        const promptText = prompt("请输入您想收藏的组合提示词:", document.getElementById("output-area").innerText.trim());

        if (promptText === null || !promptText.trim()) {
            return; 
        }

        const name = prompt("请为此组合命名：", defaultName);

        if (name) {
            const combinations = loadCombinations();
            const finalName = name.trim() || defaultName;
            combinations.push({ 
                name: finalName, 
                prompt: promptText.trim() 
            });
            saveCombinations(combinations);
            renderCombinations();
            notify(`组合 "${finalName}" 已成功收藏！`, 'success', 2000);
        }
    }

    function renderCombinations() {
        const listElement = document.getElementById("combination-list");
        listElement.innerHTML = ''; 
        const combinations = loadCombinations();

        if (combinations.length === 0) {
            listElement.innerHTML = '<li style="color: #999; font-size: 14px;">暂无收藏的组合。</li>';
            return;
        }

        combinations.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'combination-item';
            li.title = item.prompt; 
            li.innerHTML = `
                <span class="item-name">${item.name}</span>
                <button class="item-delete" data-index="${index}">删除</button>
            `;

            li.onclick = (e) => {
                if (e.target.className.includes('item-delete')) return; 

                navigator.clipboard.writeText(item.prompt).then(() => {
                    notify(`✅ 组合 "${item.name}" 已复制到剪贴板！`, 'success', 2000);
                }).catch(err => {
                    console.error('复制失败:', err);
                    notify('复制失败，请手动复制！', 'error', 4000);
                });
            };

            const deleteButton = li.querySelector('.item-delete');
            deleteButton.onclick = (e) => {
                e.stopPropagation(); 
                // ⭐️ 一键删除，用户需自负后果 (如您所愿)
                deleteCombination(index);
                notify(`组合 "${item.name}" 已删除。`, 'info', 2000);
            };
            
            listElement.appendChild(li);
        });
    }

    function deleteCombination(index) {
        let combinations = loadCombinations();
        if (index >= 0 && index < combinations.length) {
            combinations.splice(index, 1); 
            saveCombinations(combinations);
            renderCombinations();
        }
    }

    /**
     * 保存所有分类提示词和组合收藏夹到TXT文件
     * ⭐️ 只使用简洁格式保存: == id ==
     */
    function saveToTXT() {
        saveData(); 

        let content = "";
        let hasContent = false;

        // 1. 保存分类提示词 (简洁格式: == id ==)
        CATEGORIES.forEach(id => {
            const textarea = document.getElementById(id);
            if (textarea.value.trim().length > 0) {
                content += `== ${id} ==\n`; // 简洁头部
                content += textarea.value.trim() + "\n\n";
                hasContent = true;
            }
        });
        
        // 2. 保存组合收藏夹内容
        const combinations = loadCombinations();
        if (combinations.length > 0) {
            content += "\n\n================================\n";
            content += "== 组合收藏夹 (COLLECTION) ==\n";
            content += "================================\n\n";

            combinations.forEach((item, index) => {
                content += `[收藏组合 NO.${index + 1} - 名称: ${item.name}]\n`;
                content += item.prompt + "\n\n";
            });
            hasContent = true;
        }

        if (!hasContent) {
            notify('没有内容可以保存。请在分类文本框或收藏夹中输入内容。', 'error', 3000);
            return;
        }

        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = '提示词_备份_分类和收藏.txt'; 
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        notify('✅ 分类和收藏已保存到 TXT 文件。', 'success', 3000);
    }

    /**
     * 提取功能：从TXT文件加载分类提示词和组合收藏夹
     * ⭐️ 只识别简洁格式: == id ==，以及组合收藏夹头部。
     */
    function loadFromTXT(event) {
        const file = event.target.files[0];
        if (!file) { return; }

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n');
            let currentCategory = null;
            const categoryContents = {};
            let inCombinationsArea = false; 
            let newCombinations = []; 
            let currentCombination = null; 
            let categoriesActuallyLoaded = 0; 

            CATEGORIES.forEach(id => { categoryContents[id] = []; });

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.length === 0) return; 

                const combinationAreaMatch = trimmedLine.match(/^== 组合收藏夹 \(COLLECTION\) ==$/);
                const categoryMatch = trimmedLine.match(/^== (.*?) ==$/);  // ⭐️ 统一识别简洁格式
                const combinationStartMatch = trimmedLine.match(/^\[收藏组合 NO.\d+ - 名称: (.*?)\]$/); 

                // 1. 检测到组合收藏夹区域的开始
                if (combinationAreaMatch) {
                    inCombinationsArea = true;
                    currentCategory = null; 
                    return; 
                }

                let categoryMatchResult = null;
                if (categoryMatch) {
                     // 排除匹配到分隔符（组合收藏夹，或纯分隔线）的情况
                    const matchedContent = categoryMatch[1].trim();
                    if (matchedContent !== '组合收藏夹 (COLLECTION)' && !matchedContent.includes('=')) {
                        categoryMatchResult = matchedContent;
                    }
                }
                
                // 2. 检测到分类头部
                if (categoryMatchResult) {
                    const categoryId = categoryMatchResult.trim();
                    if (CATEGORIES.includes(categoryId)) {
                        currentCategory = categoryId;
                    } else {
                        currentCategory = null; // 非法的分类 ID，忽略该块内容
                    }
                    inCombinationsArea = false; 
                    currentCombination = null;
                    return; 
                } 
                
                // 3. 处于组合收藏夹区域，处理组合项
                if (inCombinationsArea) {
                    if (combinationStartMatch) {
                        // 结束上一个组合，开始新的组合
                        if (currentCombination && currentCombination.prompt.trim()) {
                            newCombinations.push(currentCombination);
                        }
                        currentCombination = { 
                            name: combinationStartMatch[1], 
                            prompt: "" 
                        };
                    } else if (currentCombination) {
                        // 积累组合的提示词内容
                        currentCombination.prompt += (currentCombination.prompt.length > 0 ? "\n" : "") + trimmedLine;
                    }
                } 
                // 4. 处于分类提示词区域
                else if (currentCategory) {
                    // 积累分类提示词内容
                    categoryContents[currentCategory].push(trimmedLine);
                }
            });

            // 确保保存最后一个解析的组合
            if (currentCombination && currentCombination.prompt.trim()) {
                newCombinations.push(currentCombination);
            }

            // 1. 加载分类内容
            CATEGORIES.forEach(id => {
                const contentLines = categoryContents[id];
                document.getElementById(id).value = contentLines.join('\n');
                if (contentLines.length > 0) {
                    categoriesActuallyLoaded++; 
                }
            });
            saveData(); 

            // 2. 加载组合收藏夹内容 (追加模式)
            if (newCombinations.length > 0) {
                let existingCombinations = loadCombinations();
                existingCombinations.push(...newCombinations);
                saveCombinations(existingCombinations);
                renderCombinations();
            }
            
            // 最终通知：基于实际加载的内容数量判断成功/失败
            if (categoriesActuallyLoaded > 0 || newCombinations.length > 0) {
                notify(`✅ 文件读取完成，已更新 ${categoriesActuallyLoaded} 个分类和导入 ${newCombinations.length} 个收藏组合。`, 'success', 4000);
            } else {
                 notify('⚠️ 文件中未检测到分类或收藏组合内容。', 'info', 3000);
            }
            event.target.value = ''; // 清空文件输入，允许再次选择同一文件
        };

        reader.readAsText(file);
    }
    
    // 核心组合逻辑 (保持不变)
    function generateSinglePrompt() {
        saveData(); 

        const allParts = [];
        const immutable = selectRandomPrompt("不修改的");
        if (immutable) {
            allParts.push(immutable);
        }

        let clothingPrompt = "";
        const selectSet = Math.random() < 0.5;

        if (selectSet) {
            clothingPrompt = selectRandomPrompt("套装");
        } else {
            const top = selectRandomPrompt("上装");
            const bottom = selectRandomPrompt("下装");
            const tempParts = [top, bottom].filter(p => p);
            clothingPrompt = tempParts.join(", ");
        }

        if (clothingPrompt) {
            allParts.push(clothingPrompt);
        }
        
        let hairstylePrompt = "";
        const useFullHairstyle = Math.random() < 0.5;

        if (useFullHairstyle) {
            hairstylePrompt = selectRandomPrompt("完整发型");
        } else {
            const front = selectRandomPrompt("前发");
            const back = selectRandomPrompt("后发");
            const tempParts = [front, back].filter(p => p);
            hairstylePrompt = tempParts.join(", ");
        }

        if (hairstylePrompt) {
            allParts.push(hairstylePrompt);
        }

        const accessoryCategories = ["身体配饰", "发色", "表情", "姿势", "镜头"]; 
        accessoryCategories.forEach(id => {
            const prompt = selectRandomPrompt(id);
            if (prompt) {
                allParts.push(prompt);
            }
        });

        return allParts.join(", ");
    }
    
    // 单次生成并复制的函数
    function generatePrompt() {
        const finalPrompt = generateSinglePrompt();
        const outputArea = document.getElementById("output-area");
        outputArea.innerText = finalPrompt || "未生成任何提示词，请检查输入是否为空。";

        if (finalPrompt) {
            navigator.clipboard.writeText(finalPrompt).then(() => {
                notify("✅ 提示词已复制到剪贴板！", 'success', 2000);
            }).catch(err => {
                console.error('复制失败:', err);
                notify('复制失败，请手动复制！', 'error', 4000);
            });
        }
    }

    // 批量生成并保存为TXT的函数
    function batchGenerateAndSaveToTXT() {
        saveData(); 

        const countInput = document.getElementById("batch-count");
        let count = parseInt(countInput.value, 10);
        const MAX_COUNT = 1000;

        if (isNaN(count) || count <= 0) {
            notify("请输入一个有效的生成数量 (大于 0)。", 'error', 3000);
            countInput.value = 1; 
            return;
        }

        if (count > MAX_COUNT) {
            notify(`⚠️ 数量 ${count} 超过建议最大值 ${MAX_COUNT}。请手动修改。`, 'error', 4000);
            return;
        }
        
        let batchContent = `\n`;
        const separator = "=== 组合提示词 - NO. "; 

        for (let i = 1; i <= count; i++) {
            const prompt = generateSinglePrompt();
            batchContent += `${separator}${i} ===\n`; 
            batchContent += prompt + "\n\n";
        }
        
        batchContent = batchContent.trim();

        if (!batchContent) {
            notify("未能生成任何提示词，请检查至少有一个分类有输入内容。", 'error', 3000);
            return;
        }

        const blob = new Blob([batchContent], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `批量提示词组合_${count}组.txt`;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        notify(`✅ 已成功批量生成 ${count} 组提示词并保存。`, 'success', 3000);
    }

    window.onload = loadData;
</script>

</body>
</html>
